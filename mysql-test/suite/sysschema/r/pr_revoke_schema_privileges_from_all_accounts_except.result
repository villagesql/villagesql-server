CREATE DATABASE test_db;
SELECT user, host FROM mysql.user;
user	host
mysql.infoschema	localhost
mysql.session	localhost
mysql.sys	localhost
root	localhost
CREATE USER 'test_user'@'localhost';
## Create schema and global level grants.
GRANT SELECT, INSERT, UPDATE ON *.* TO 'test_user'@'localhost';
GRANT INSERT, UPDATE, DELETE ON test_db.* TO 'test_user'@'localhost';
SET @old_partial_revokes = @@partial_revokes;
## Run the script on non existing schema. Should exit with error.
CALL sys.revoke_schema_privileges_from_all_accounts_except("non_existring_schema", JSON_ARRAY("SELECT", "insert", "Update", "deletE"), JSON_ARRAY("'root'@'localhost'", "'mysql.infoschema'@'LOCALHOST'", "'mysql.session'@'Localhost'", "'mysql.sys'@'locaLHost'"));
ERROR 45000: The schema does not exist
## Partial revokes is required to revoke privilege on global level.
SET GLOBAL partial_revokes = 1;
## User grants.
SHOW GRANTS FOR 'test_user'@'localhost';
Grants for test_user@localhost
GRANT SELECT, INSERT, UPDATE ON *.* TO `test_user`@`localhost`
GRANT INSERT, UPDATE, DELETE ON `test_db`.* TO `test_user`@`localhost`
## Schema level privilege should be present.
SELECT * FROM INFORMATION_SCHEMA.SCHEMA_PRIVILEGES WHERE TABLE_SCHEMA = 'test_db' AND GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
GRANTEE	TABLE_CATALOG	TABLE_SCHEMA	PRIVILEGE_TYPE	IS_GRANTABLE
'test_user'@'localhost'	def	test_db	DELETE	NO
'test_user'@'localhost'	def	test_db	INSERT	NO
'test_user'@'localhost'	def	test_db	UPDATE	NO
## Global level privilege should be present.
SELECT grantee, privilege_type FROM INFORMATION_SCHEMA.USER_PRIVILEGES WHERE GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
grantee	privilege_type
'test_user'@'localhost'	INSERT
'test_user'@'localhost'	SELECT
'test_user'@'localhost'	UPDATE
## There should be no partial revoke restriction.
SELECT User, Host, User_attributes FROM mysql.user WHERE User = 'test_user';
User	Host	User_attributes
test_user	localhost	NULL
## Revoke INSERT, UPDATE privileges from schema.
## #############################################
CALL sys.revoke_schema_privileges_from_all_accounts_except("test_db", JSON_ARRAY("insert", "Update"), JSON_ARRAY("'root'@'localhost'", "'mysql.infoschema'@'LOCALHOST'", "'mysql.session'@'Localhost'", "'mysql.sys'@'locaLHost'"));
## User grants.
SHOW GRANTS FOR 'test_user'@'localhost';
Grants for test_user@localhost
GRANT SELECT, INSERT, UPDATE ON *.* TO `test_user`@`localhost`
GRANT DELETE ON `test_db`.* TO `test_user`@`localhost`
REVOKE INSERT, UPDATE ON `test_db`.* FROM `test_user`@`localhost`
## Schema privilege should be missing.
SELECT * FROM INFORMATION_SCHEMA.SCHEMA_PRIVILEGES WHERE TABLE_SCHEMA = 'test_db' AND GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
GRANTEE	TABLE_CATALOG	TABLE_SCHEMA	PRIVILEGE_TYPE	IS_GRANTABLE
'test_user'@'localhost'	def	test_db	DELETE	NO
## Global privileges should be present.
SELECT grantee, privilege_type FROM INFORMATION_SCHEMA.USER_PRIVILEGES WHERE GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
grantee	privilege_type
'test_user'@'localhost'	INSERT
'test_user'@'localhost'	SELECT
'test_user'@'localhost'	UPDATE
## There should be schema restriction present.
SELECT User, Host, User_attributes FROM mysql.user WHERE User = 'test_user';
User	Host	User_attributes
test_user	localhost	{"Restrictions": [{"Database": "test_db", "Privileges": ["INSERT", "UPDATE"]}]}
## Revoke SELECT, INSERT privileges from schema.
## #############################################
CALL sys.revoke_schema_privileges_from_all_accounts_except("test_db", JSON_ARRAY("insert", "SELECT"), JSON_ARRAY("'root'@'localhost'", "'mysql.infoschema'@'LOCALHOST'", "'mysql.session'@'Localhost'", "'mysql.sys'@'locaLHost'"));
## User grants.
SHOW GRANTS FOR 'test_user'@'localhost';
Grants for test_user@localhost
GRANT SELECT, INSERT, UPDATE ON *.* TO `test_user`@`localhost`
GRANT DELETE ON `test_db`.* TO `test_user`@`localhost`
REVOKE SELECT, INSERT, UPDATE ON `test_db`.* FROM `test_user`@`localhost`
## Schema privilege should be missing.
SELECT * FROM INFORMATION_SCHEMA.SCHEMA_PRIVILEGES WHERE TABLE_SCHEMA = 'test_db' AND GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
GRANTEE	TABLE_CATALOG	TABLE_SCHEMA	PRIVILEGE_TYPE	IS_GRANTABLE
'test_user'@'localhost'	def	test_db	DELETE	NO
## Global privileges should be present.
SELECT grantee, privilege_type FROM INFORMATION_SCHEMA.USER_PRIVILEGES WHERE GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
grantee	privilege_type
'test_user'@'localhost'	INSERT
'test_user'@'localhost'	SELECT
'test_user'@'localhost'	UPDATE
## There should be schema restriction present.
SELECT User, Host, User_attributes FROM mysql.user WHERE User = 'test_user';
User	Host	User_attributes
test_user	localhost	{"Restrictions": [{"Database": "test_db", "Privileges": ["SELECT", "INSERT", "UPDATE"]}]}
## Revoke UPDATE, DELETE privileges from schema.
## #############################################
CALL sys.revoke_schema_privileges_from_all_accounts_except("test_db", JSON_ARRAY("Update", "deletE"), JSON_ARRAY("'root'@'localhost'", "'mysql.infoschema'@'LOCALHOST'", "'mysql.session'@'Localhost'", "'mysql.sys'@'locaLHost'"));
## User grants.
SHOW GRANTS FOR 'test_user'@'localhost';
Grants for test_user@localhost
GRANT SELECT, INSERT, UPDATE ON *.* TO `test_user`@`localhost`
REVOKE SELECT, INSERT, UPDATE ON `test_db`.* FROM `test_user`@`localhost`
## Schema privilege should be missing.
SELECT * FROM INFORMATION_SCHEMA.SCHEMA_PRIVILEGES WHERE TABLE_SCHEMA = 'test_db' AND GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
GRANTEE	TABLE_CATALOG	TABLE_SCHEMA	PRIVILEGE_TYPE	IS_GRANTABLE
## Global privileges should be present.
SELECT grantee, privilege_type FROM INFORMATION_SCHEMA.USER_PRIVILEGES WHERE GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
grantee	privilege_type
'test_user'@'localhost'	INSERT
'test_user'@'localhost'	SELECT
'test_user'@'localhost'	UPDATE
## There should be schema restriction present.
SELECT User, Host, User_attributes FROM mysql.user WHERE User = 'test_user';
User	Host	User_attributes
test_user	localhost	{"Restrictions": [{"Database": "test_db", "Privileges": ["SELECT", "INSERT", "UPDATE"]}]}
## Drop the user, so all modifications are gone.
DROP USER 'test_user'@'localhost';
## Test the script with 'ANSI_QUOTES' turned on.
SET GLOBAL sql_mode = 'ANSI_QUOTES';
## Create the user back and grant privileges as on the beginning.
CREATE USER 'test_user'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE ON *.* TO 'test_user'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE ON test_db.* TO 'test_user'@'localhost';
## Revoke privileges from schema.
## ##############################
CALL sys.revoke_schema_privileges_from_all_accounts_except("test_db", JSON_ARRAY("SELECT", "insert", "Update", "deletE"), JSON_ARRAY("'root'@'localhost'", "'mysql.infoschema'@'LOCALHOST'", "'mysql.session'@'Localhost'", "'mysql.sys'@'locaLHost'"));
## User grants.
SHOW GRANTS FOR 'test_user'@'localhost';
Grants for test_user@localhost
GRANT SELECT, INSERT, UPDATE, DELETE ON *.* TO `test_user`@`localhost`
REVOKE SELECT, INSERT, UPDATE, DELETE ON `test_db`.* FROM `test_user`@`localhost`
## Schema privilege should be missing.
SELECT * FROM INFORMATION_SCHEMA.SCHEMA_PRIVILEGES WHERE TABLE_SCHEMA = 'test_db' AND GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
GRANTEE	TABLE_CATALOG	TABLE_SCHEMA	PRIVILEGE_TYPE	IS_GRANTABLE
## Global privileges should be present.
SELECT grantee, privilege_type FROM INFORMATION_SCHEMA.USER_PRIVILEGES WHERE GRANTEE NOT IN ("'root'@'localhost'", "'mysql.infoschema'@'localhost'", "'mysql.session'@'localhost'", "'mysql.sys'@'localhost'") ORDER BY PRIVILEGE_TYPE;
grantee	privilege_type
'test_user'@'localhost'	DELETE
'test_user'@'localhost'	INSERT
'test_user'@'localhost'	SELECT
'test_user'@'localhost'	UPDATE
## There should be schema restriction present.
SELECT User, Host, User_attributes FROM mysql.user WHERE User = 'test_user';
User	Host	User_attributes
test_user	localhost	{"Restrictions": [{"Database": "test_db", "Privileges": ["SELECT", "INSERT", "UPDATE", "DELETE"]}]}
DROP USER 'test_user'@'localhost';
DROP DATABASE test_db;
SET GLOBAL partial_revokes = @old_partial_revokes;
SET GLOBAL sql_mode = DEFAULT;
