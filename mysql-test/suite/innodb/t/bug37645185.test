--echo #
--echo # Bug #37645185: Improve redo log related error log messages
--echo #

--disable_warnings
call mtr.add_suppression("\\[Warning\\] .*MY-\\d+.* InnoDB redo logging is disabled. All data could be lost in case of a server crash. Current lsn is \\d+.");
call mtr.add_suppression("\\[Warning\\] .*MY-\\d+.* InnoDB redo logging is enabled. Data is now safe and can be recovered in case of a server crash.");

--echo '#-------------------------------------------------------------------------#'
--echo ## Disable REDO_LOG to verify the wrn_msg ER_IB_WRN_REDO_DISABLED_INFO

# Check error_log message after REDO_LOG disable
let SEARCH_FILE= $MYSQLTEST_VARDIR/log/mysqld.1.err;
ALTER INSTANCE DISABLE INNODB REDO_LOG;
--let SEARCH_PATTERN= InnoDB redo logging is disabled. All data could be lost in case of a server crash. Current lsn is
--source include/search_pattern.inc

# REDO_LOG enable
ALTER INSTANCE ENABLE INNODB REDO_LOG;
SHOW GLOBAL STATUS LIKE 'Innodb_redo_log_enabled';
--enable_warnings


--echo '#-------------------------------------------------------------------------#'

--let $innodb_status= $MYSQL_TMP_DIR/innodb_status
--echo mysql -e "SHOW ENGINE INNODB STATUS"
--exec $MYSQL -e "SHOW ENGINE INNODB STATUS" > $innodb_status

--let SEARCH_FILE=$innodb_status
--let SEARCH_PATTERN=Log capacity
--echo Grepping InnoDB status for $SEARCH_PATTERN
--source include/search_pattern.inc

--let SEARCH_FILE=$innodb_status
--let SEARCH_PATTERN=Log capacity used
--echo Grepping InnoDB status for $SEARCH_PATTERN
--source include/search_pattern.inc
--remove_file $innodb_status

--let $innodb_status= $MYSQL_TMP_DIR/innodb_status
--echo mysql -e "SELECT VARIABLE_NAME FROM performance_schema.global_variables WHERE VARIABLE_NAME LIKE 'innodb_redo_log_%';"
--exec $MYSQL -e "SELECT VARIABLE_NAME FROM performance_schema.global_variables WHERE VARIABLE_NAME LIKE 'innodb_redo_log_%';" > $innodb_status

--let SEARCH_FILE=$innodb_status
--let SEARCH_PATTERN=innodb_redo_log_capacity
--echo Grepping InnoDB status for $SEARCH_PATTERN
--source include/search_pattern.inc
--remove_file $innodb_status
