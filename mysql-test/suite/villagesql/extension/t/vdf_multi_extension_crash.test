# Reproduction test: loading two extensions with similar VDF signatures
# causes func_desc pointer sharing due to COMDAT/ICF merging of static
# variables in materialize_func_desc<>. Uninstalling one extension
# invalidates the other extension's func_desc pointers.
#
# This test uses only qualified VDF calls (extension.function syntax).

--echo # Test: VDF crash when two extensions share func_desc pointers

# Setup VEB directory for testing
--let $veb_dir = $MYSQLTEST_VARDIR/veb
--exec mkdir -p $veb_dir

# Restart server with --veb-dir option
call mtr.add_suppression("Orphaned expansion directory found but not removed");
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters = restart: --veb-dir=$veb_dir
--source include/restart_mysqld.inc

# Create first extension
--let $extension_name = test_vdf_ext
--let $extension_version = 1.0.0
--let $extension_source = $MYSQL_TEST_DIR/suite/villagesql/std_data/simple_vdf.cc
--source include/villagesql/create_extension_sdk.inc

# Create second extension (has overlapping function name: simple_int_func)
--let $extension_name = test_vdf_alt
--let $extension_version = 1.0.0
--let $extension_source = $MYSQL_TEST_DIR/suite/villagesql/std_data/simple_vdf_alt.cc
--source include/villagesql/create_extension_sdk.inc

--echo # Install both extensions
INSTALL EXTENSION test_vdf_ext;
INSTALL EXTENSION test_vdf_alt;

--echo # Qualified calls work with both extensions loaded
SELECT test_vdf_ext.simple_int_func() AS result;
SELECT test_vdf_alt.simple_int_func() AS result;

--echo # Uninstall second extension only
UNINSTALL EXTENSION test_vdf_alt;

--echo # Qualified call to first extension should still work
SELECT test_vdf_ext.simple_int_func() AS result;

--echo # Cleanup
UNINSTALL EXTENSION test_vdf_ext;
