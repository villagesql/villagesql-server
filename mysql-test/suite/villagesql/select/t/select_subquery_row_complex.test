# Test Row Subqueries with COMPLEX type
# Grammar: SELECT ... WHERE (col1, col2) = (SELECT col1, col2 ...)

--source include/villagesql/install_complex_extension.inc

CREATE TABLE t1 (id INT, val COMPLEX);
INSERT INTO t1 VALUES
  (1, '(0.0,0.0)'),
  (6, '(4.22e-10,3.14e-15)'),
  (2, '(1.0,2.0)'),
  (3, '(3.0,4.0)'),
  (5, '(1.5e100,2.3e100)'),
  (7, '(-5.0,3.0)'),
  (4, '(-1.0,-2.0)'),
  (8, '(-0,0)');

CREATE TABLE t2 (id INT, val COMPLEX);
INSERT INTO t2 VALUES
  (11, '(0.0,0.0)'),
  (16, '(4.22e-10,3.14e-15)'),
  (2, '(-0,2.0)'),
  (3, '(-0,-0)'),
  (5, '(1e99,2.3e100)'),
  (17, '(5.0,3.0)'),
  (4, '(-1.0,-2.0)'),
  (1, '(-0,0)');

# Row equality with subquery - LIMIT 1 gets first row (11, '(0.0,0.0)'), no match in t1
SELECT * FROM t1 WHERE (id, val) = (SELECT id, val FROM t2 LIMIT 1);

# Without LIMIT 1, subquery returns multiple rows - should error
--error ER_SUBQUERY_NO_1_ROW
SELECT * FROM t1 WHERE (id, val) = (SELECT id, val FROM t2 ORDER BY id);

# With WHERE to get a specific row that matches
SELECT * FROM t1 WHERE (id, val) = (SELECT id, val FROM t2 WHERE id = 4 LIMIT 1);

# Note: shows "ERROR 3219 (HY000): Cannot compare values of custom and non-custom types in ="
SELECT * FROM t1 WHERE (val) = (SELECT val FROM t2 ORDER BY id LIMIT 1);

SELECT * FROM t1 WHERE (val) = (SELECT val FROM t2 ORDER BY val LIMIT 1);

# Row IN subquery
SELECT * FROM t1 WHERE (id, val) IN (SELECT id, val FROM t2);

DROP TABLE t1;
DROP TABLE t2;

--source include/villagesql/uninstall_complex_extension.inc
