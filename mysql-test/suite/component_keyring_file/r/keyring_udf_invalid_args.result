# ----------------------------------------------------------------------
# Setup
# Creating local configuration file for keyring component: component_keyring_file
# Creating manifest file for current MySQL server instance
# Re-starting mysql server with manifest file
# ----------------------------------------------------------------------
#============= preparation =============#
INSTALL PLUGIN keyring_udf SONAME 'keyring_udf.so';
CREATE FUNCTION keyring_key_store RETURNS INTEGER SONAME 'keyring_udf.so';
CREATE FUNCTION keyring_key_generate RETURNS INTEGER SONAME 'keyring_udf.so';
CREATE FUNCTION keyring_key_fetch RETURNS sTRING SONAME 'keyring_udf.so';
CREATE FUNCTION keyring_key_type_fetch RETURNS STRING SONAME 'keyring_udf.so';
CREATE FUNCTION keyring_key_length_fetch RETURNS INTEGER SONAME 'keyring_udf.so';
CREATE FUNCTION keyring_key_remove RETURNS INTEGER SONAME 'keyring_udf.so';
CREATE DATABASE tmp;
USE tmp;
CREATE TABLE name(id INT, name varchar(10));
INSERT INTO name VALUES (1, '');
INSERT INTO name VALUES (2, NULL);
INSERT INTO name VALUES (3, 'key3');
CREATE TABLE len(id INT, name varchar(10), len INT);
INSERT INTO len VALUES (1, 'key1', -1);
INSERT INTO len VALUES (2, 'key2', NULL);
INSERT INTO len VALUES (3, 'key3', 20000);
INSERT INTO len VALUES (4, 'key4', 16);
CREATE TABLE type(id INT, name varchar(10), type varchar(10));
INSERT INTO type VALUES (1, 'key1', '');
INSERT INTO type VALUES (2, 'key2', NULL);
INSERT INTO type VALUES (3, 'key3', 'invalid');
INSERT INTO type VALUES (4, 'key4', 'SECRET');
CREATE TABLE val(id INT, name varchar(10), val varchar(16));
INSERT INTO val VALUES (1, 'key1', '');
INSERT INTO val VALUES (2, 'key2', NULL);
INSERT INTO val VALUES (3, 'key3', 'Valid key text');
#=========== keyring_key_generate ===========#
SELECT keyring_key_generate(NULL, 'SECRET', 16);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Key id cannot be NULL.
SELECT keyring_key_generate('', 'SECRET', 16);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Key id cannot be empty.
# The last row should be 1, the rest should be NULL
SELECT keyring_key_generate(name, 'SECRET', 16) FROM name ORDER BY id;
keyring_key_generate(name, 'SECRET', 16)
NULL
NULL
1
SELECT keyring_key_remove('key3');
keyring_key_remove('key3')
1
SELECT keyring_key_generate('key', NULL, 16);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Key id cannot be NULL.
SELECT keyring_key_generate('key', '', 16);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Invalid key type.
SELECT keyring_key_generate('key', 'invalid-type', 32);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Invalid key type.
# For a keyring component: the last 2 rows should be 1, the rest should be NULL
# For a keyring plugin: the last row should be 1, the rest should be NULL
SELECT keyring_key_generate(name, type, 16) FROM type ORDER BY id;
keyring_key_generate(name, type, 16)
NULL
NULL
1
1
SELECT keyring_key_remove('key4');
keyring_key_remove('key4')
1
SELECT keyring_key_generate('key', 'SECRET', NULL);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Mismatch encountered. An integer argument is expected for key length.
SELECT keyring_key_generate('key', 'SECRET', -1);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Invalid length of the key.
SELECT keyring_key_generate('key', 'SECRET', 0);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Invalid length of the key.
SELECT keyring_key_generate('key', 'SECRET', 18000);
ERROR HY000: Can't initialize function 'keyring_key_generate'; Invalid length of the key.
# The last row should be 1, the rest should be NULL
SELECT keyring_key_generate(name, 'SECRET', len) FROM len ORDER BY id;
keyring_key_generate(name, 'SECRET', len)
NULL
NULL
NULL
1
SELECT keyring_key_remove('key4');
keyring_key_remove('key4')
1
#=========== keyring_key_store ===========#
SELECT keyring_key_store(NULL, 'SECRET', 'Valid key text');
ERROR HY000: Can't initialize function 'keyring_key_store'; Key id cannot be NULL.
SELECT keyring_key_store('', 'SECRET', 'Valid key text');
ERROR HY000: Can't initialize function 'keyring_key_store'; Key id cannot be empty.
# The last row should be 1, the rest should be NULL
SELECT keyring_key_store(name, 'SECRET', 'Valid key text') FROM name ORDER BY id;
keyring_key_store(name, 'SECRET', 'Valid key text')
NULL
NULL
NULL
SELECT keyring_key_remove('key3');
keyring_key_remove('key3')
1
SELECT keyring_key_store('key', NULL, 'Valid key text');
ERROR HY000: Can't initialize function 'keyring_key_store'; Key id cannot be NULL.
SELECT keyring_key_store('key', '', 'Valid key text');
ERROR HY000: Can't initialize function 'keyring_key_store'; Invalid key type.
SELECT keyring_key_store('key', 'invalid-type', 'Valid key text');
ERROR HY000: Can't initialize function 'keyring_key_store'; Invalid key type.
# For a keyring component: the last 2 rows should be 1, the rest should be NULL
# For a keyring plugin: the last row should be 1, the rest should be NULL
SELECT keyring_key_store(name, type, 'Valid key text') FROM type ORDER BY id;
keyring_key_store(name, type, 'Valid key text')
NULL
NULL
1
1
SELECT keyring_key_remove('key4');
keyring_key_remove('key4')
1
SELECT keyring_key_store('key', 'SECRET', NULL);
ERROR HY000: Can't initialize function 'keyring_key_store'; Key cannot be NULL.
SELECT keyring_key_store('key', 'SECRET', '');
ERROR HY000: Can't initialize function 'keyring_key_store'; Invalid length of the key.
# The last row should be 1, the rest should be NULL
SELECT keyring_key_store(name, 'SECRET', val) FROM val ORDER BY id;
keyring_key_store(name, 'SECRET', val)
1
NULL
NULL
SELECT keyring_key_remove('key3');
keyring_key_remove('key3')
1
#=========== keyring_key_fetch ===========#
SELECT keyring_key_fetch(NULL);
ERROR HY000: Can't initialize function 'keyring_key_fetch'; Key id cannot be NULL.
SELECT keyring_key_fetch('');
ERROR HY000: Can't initialize function 'keyring_key_fetch'; Key id cannot be empty.
# all should be NULL
SELECT keyring_key_fetch(name) FROM name ORDER BY id;
keyring_key_fetch(name)
NULL
NULL
NULL
#=========== keyring_key_type_fetch ===========#
SELECT keyring_key_type_fetch(NULL);
ERROR HY000: Can't initialize function 'keyring_key_type_fetch'; Key id cannot be NULL.
SELECT keyring_key_type_fetch('');
ERROR HY000: Can't initialize function 'keyring_key_type_fetch'; Key id cannot be empty.
# all should be NULL
SELECT keyring_key_type_fetch(name) FROM name ORDER BY id;
keyring_key_type_fetch(name)
NULL
NULL
NULL
#=========== keyring_key_length_fetch ===========#
SELECT keyring_key_length_fetch(NULL);
ERROR HY000: Can't initialize function 'keyring_key_length_fetch'; Key id cannot be NULL.
SELECT keyring_key_length_fetch('');
ERROR HY000: Can't initialize function 'keyring_key_length_fetch'; Key id cannot be empty.
# all should be NULL
SELECT keyring_key_length_fetch(name) FROM name ORDER BY id;
keyring_key_length_fetch(name)
NULL
NULL
NULL
#=========== keyring_key_remove ===========#
SELECT keyring_key_remove(NULL);
ERROR HY000: Can't initialize function 'keyring_key_remove'; Key id cannot be NULL.
SELECT keyring_key_remove('');
ERROR HY000: Can't initialize function 'keyring_key_remove'; Key id cannot be empty.
# all should be NULL
SELECT keyring_key_remove(name) FROM name ORDER BY id;
keyring_key_remove(name)
NULL
NULL
NULL
#=============== cleanup ===============#
DROP FUNCTION keyring_key_store;
DROP FUNCTION keyring_key_fetch;
DROP FUNCTION keyring_key_remove;
DROP FUNCTION keyring_key_generate;
DROP FUNCTION keyring_key_type_fetch;
DROP FUNCTION keyring_key_length_fetch;
UNINSTALL PLUGIN keyring_udf;
DROP DATABASE tmp;
# ----------------------------------------------------------------------
# Teardown
# Removing manifest file for current MySQL server instance
# Removing local keyring file for keyring component: component_keyring_file
# Removing local configuration file for keyring component: component_keyring_file
# Restarting server without the manifest file
# ----------------------------------------------------------------------
