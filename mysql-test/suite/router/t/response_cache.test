--source include/have_router.inc

--let $extra_mrs_router_id=1
--source ../include/predefined_setup/configure_router_mrs_root.inc
--source ../include/schema/basic_schema.sql

--source ../include/mrs/start_object_definition.inc

# The test uses HOST to have only paths in HREF fields.
--let $mrs_add_service_path="/svc"
--let $mrs_add_host_name=""
--source ../include/mrs/service/add.inc

--let $mrs_add_schema=basic_schema
--let $mrs_add_schema_path=/basic
--source ../include/mrs/db_schema/add.inc

--let $mrs_add_db_object=table1
--let $mrs_add_db_object_path=/t1
--let $mrs_add_db_object_options='{"logging":{"exceptions":true, "request":{"headers":true, "body":true}, "response":{"headers":true, "body":true}}}'
--source ../include/mrs/db_object/add.inc

--let $mrs_add_db_object=table4
--let $mrs_add_db_object_path=/t4
--let $mrs_add_db_object_options='{"logging":{"exceptions":true, "request":{"headers":true, "body":true}, "response":{"headers":true, "body":true}}}'
--source ../include/mrs/db_object/add.inc

--let $mrs_add_db_object=table2
--let $mrs_add_db_object_path=/t2
--source ../include/mrs/db_object/add.inc

--let $mrs_add_db_object_type=PROCEDURE
--let $mrs_add_db_object=proc_table4
--let $mrs_add_db_object_path=/proc
--source ../include/mrs/db_object/add.inc

--let $mrs_add_content_set_enabled=1
--let $mrs_add_content_set_path=/static
--source ../include/mrs/content_set/add.inc

--let $mrs_add_content='TEST FILE CONTENT\nEND OF FILE\n'
--let $mrs_add_content_file_path=/file1
--source ../include/mrs/content_file/add.inc

--let $mrs_add_content='TEST FILE 2 CONTENT\nEND OF FILE 2\n'
--let $mrs_add_content_file_path=/file2
--source ../include/mrs/content_file/add.inc

# Set cache size for files and data
update mysql_rest_service_metadata.config set data = json_merge_patch(data, '{"responseCache":{"maxCacheSize":200}, "fileCache":{"maxCacheSize":40}}');

# Enable caching for t1 and proc
update mysql_rest_service_metadata.db_object set options='{"cacheTimeToLive":5}' where name='table1';
update mysql_rest_service_metadata.db_object set options='{"cacheTimeToLive":5}' where name='proc_table4';

--source ../include/mrs/end_object_definition.inc

update performance_schema.setup_consumers set enabled=1 where name='events_statements_history';

select json_object('endpoints', max(details->'$.restCachedEndpoints'), 'itemLoads', max(details->'$.restCacheItemLoads'), 'itemEjects', max(details->'$.restCacheItemEjects'), 'itemHits', max(details->'$.restCacheItemHits'), 'itemMisses', max(details->'$.restCacheItemMisses'), 'items', max(details->'$.restCachedItems'), 'fileLoads', max(details->'$.restCacheFileLoads'), 'fileEjects', max(details->'$.restCacheFileEjects'), 'fileHits', max(details->'$.restCacheFileHits'), 'fileMisses', max(details->'$.restCacheFileMisses'), 'files', max(details->'$.restCachedFiles')) as stats from mysql_rest_service_metadata.router_status;

#
# test that cached table is cached
#
select count(*) into @before from performance_schema.events_statements_history where sql_text like '%/svc/basic/t1%' and thread_id<>ps_current_thread_id();

--exec $MRS_CLIENT_ARGS --path /svc/basic/t1/20

select count(*), @before+1 from performance_schema.events_statements_history where sql_text like '%/svc/basic/t1%' and thread_id<>ps_current_thread_id();

select IF(count(*)=@before+1,'PASS','FAIL') from performance_schema.events_statements_history where sql_text like '%/svc/basic/t1%' and thread_id<>ps_current_thread_id();

--exec $MRS_CLIENT_ARGS --path /svc/basic/t1/20

select IF(count(*)=@before+1,'PASS','FAIL') from performance_schema.events_statements_history where sql_text like '%/svc/basic/t1%' and thread_id<>ps_current_thread_id();

#
# test that uncached table is not cached
#
select count(*) into @before from performance_schema.events_statements_history where sql_text like '%/svc/basic/t2%' and thread_id<>ps_current_thread_id();
--exec $MRS_CLIENT_ARGS --path /svc/basic/t2/1

select IF(count(*)=@before+1,'PASS','FAIL') from performance_schema.events_statements_history where sql_text like '%/svc/basic/t2%' and thread_id<>ps_current_thread_id();

--exec $MRS_CLIENT_ARGS --path /svc/basic/t2/1

select IF(count(*)=@before+2,'PASS','FAIL') from performance_schema.events_statements_history where sql_text like '%/svc/basic/t2%' and thread_id<>ps_current_thread_id();

#
# test that cached SP is cached
#
--let $mrs_client_arg_path='/svc/basic/proc'
--let $mrs_client_arg_request_type='PUT'
--let $mrs_client_arg_payload='{}'
--source ../include/mrs/mrs_client.inc

--let $mrs_client_arg_path='/svc/basic/proc'
--let $mrs_client_arg_request_type='PUT'
--let $mrs_client_arg_payload='{}'
--source ../include/mrs/mrs_client.inc

# only 1 row is supposed to have been added
select * from basic_schema.table4;

#
# test that content_file is cached
#

select count(*) into @before from performance_schema.events_statements_history where sql_text like '%content_file WHERE id=%' and thread_id<>ps_current_thread_id();
--exec $MRS_CLIENT_ARGS --path /svc/static/file1 --response-type RAW --display none

select IF(count(*)=@before+1,'PASS','FAIL') from performance_schema.events_statements_history where sql_text like '%content_file WHERE id=%' and thread_id<>ps_current_thread_id();

--exec $MRS_CLIENT_ARGS --path /svc/static/file1 --response-type RAW --display none

select IF(count(*)=@before+1,'PASS','FAIL') from performance_schema.events_statements_history where sql_text like '%content_file WHERE id=%' and thread_id<>ps_current_thread_id();

# this will eject file1
--exec $MRS_CLIENT_ARGS --path /svc/static/file2 --response-type RAW --display none

# wait for MD to be updated with stats
--source ../include/mrs/wait_mrs_read_metadata.inc

select json_object('endpoints', max(details->'$.restCachedEndpoints'), 'itemLoads', max(details->'$.restCacheItemLoads'), 'itemEjects', max(details->'$.restCacheItemEjects'), 'itemHits', max(details->'$.restCacheItemHits'), 'itemMisses', max(details->'$.restCacheItemMisses'), 'items', max(details->'$.restCachedItems'), 'fileLoads', max(details->'$.restCacheFileLoads'), 'fileEjects', max(details->'$.restCacheFileEjects'), 'fileHits', max(details->'$.restCacheFileHits'), 'fileMisses', max(details->'$.restCacheFileMisses'), 'files', max(details->'$.restCachedFiles')) as stats from mysql_rest_service_metadata.router_status;

# Cleanup
--source ../include/mrs/cleanup.inc
