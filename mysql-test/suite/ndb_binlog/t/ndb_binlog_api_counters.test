################################################################################
# Test the NDB Event API counters for the binlog injector consumer. Each test
# assesses that counters match the expected intervals
################################################################################

--source include/have_ndb.inc
--source include/have_binlog_format_mixed_or_row.inc

--echo #####################################################################
--echo # With sql_log_bin=0, data events are not sent to the binlog injector
--echo #####################################################################

SET sql_log_bin=0;

CREATE TABLE t1 (a INT PRIMARY KEY, b BLOB, lb LONGBLOB, lt LONGTEXT) ENGINE = NDB;

SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Ndb_api_event_bytes_count_injector' INTO @start_event_bytes;

INSERT INTO t1 VALUES (1, repeat('!', 4096), repeat('@', 65536), repeat('lorem', 65536)),
                      (2, repeat('#', 4096), repeat('$', 65536), repeat('ipsum', 65536));
# Wait for gci to close and move
--save_master_pos

SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Ndb_api_event_bytes_count_injector' INTO @end_event_bytes;

if (`SELECT @end_event_bytes - @start_event_bytes >= 4096`)
{
  echo # More than 4096 bytes of event data was received.
  echo start value: `SELECT @start_event_bytes`;
  echo end value: `SELECT @end_event_bytes`;
  die "Expected less than 4096 bytes of data for the events received";
}
--echo # No more than 4096 bytes of event data was received

SET sql_log_bin=1;
DROP TABLE t1;

