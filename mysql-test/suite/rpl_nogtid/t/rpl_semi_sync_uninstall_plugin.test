# ==== Purpose ====
#
# Verify that UNINSTALL PLUGIN is blocked for semisync plugins, when
# the plugins are active.
#
# ==== Requirements ====
#
# R1. Installation of source plugins should be disallowed if there are
#     running dump threads having semi-sync replicas.
#
# R2. Installation of replica plugins should be disallowed if there are
#     running receiver threads where semi-sync is enabled.
#
# R3. The above should hold both for old-named plugins and for new-named
#     plugins.
#
# ==== References ====
#
# BUG#17638477 UNINSTALL AND INSTALL SEMI-SYNC PLUGIN CAUSES SLAVES TO BREAK
# Uninstallation was not blocked before this bugfix.
#
# BUG#33270401: Uninstall not blocked for active old-named semi-sync replication plugins
# Uninstallation was not blocked on old-named plugins before this bugfix.

--source include/have_semisync_plugin.inc
--source include/have_binlog_format_row.inc
--source include/rpl/init_source_replica.inc

--let $status = _status
--let $clients = _clients
--let $enabled = _enabled

--let $source = source
--let $replica = replica
--let $source_plugin = $SEMISYNC_SOURCE_PLUGIN
--let $replica_plugin = $SEMISYNC_REPLICA_PLUGIN

--source include/rpl/connection_source.inc

#############################################################################
--echo # Case 1: Uninstallation of semi-sync plugins should be allowed when it is
--echo # not in use i.e., when asynchronous replication is active.

# Step 1.1: Install semi-sync source plugin on source
--replace_result $source_plugin SEMISYNC_SOURCE_PLUGIN
eval INSTALL PLUGIN rpl_semi_sync_$source SONAME '$source_plugin';

# Step 1.2: Install semi-sync replica plugin on replica
--source include/rpl/connection_replica.inc
--replace_result $replica_plugin SEMISYNC_REPLICA_PLUGIN
eval INSTALL PLUGIN rpl_semi_sync_$replica SONAME '$replica_plugin';

# Step 1.3: Uninstallation of semisync plugin on source and replica should be
#  allowed at this state as there is no semi-sync replication enabled between
#  source and replica.
eval UNINSTALL PLUGIN rpl_semi_sync_$replica;
--source include/rpl/connection_source.inc
eval UNINSTALL PLUGIN rpl_semi_sync_$source;

# Step 1.4: Check that replication is working fine at the end of the test case.
CREATE TABLE t1(i int);
INSERT INTO t1 values (1);
DROP TABLE t1;
--sync_slave_with_master

#############################################################################
--echo # Case 2: Uninstallation of semi-sync plugins should be disallowed
--echo # when it is in use i.e., when semi-sync replication is active

# Step 2.1: Install and enable semi-sync replication between source and replica
--source include/rpl/install_semisync.inc

# Step 2.2: Check that rpl_semi_sync_replica uninstallation on Replica is not
#  possible at this state
--source include/rpl/connection_replica.inc
eval call mtr.add_suppression("Plugin 'rpl_semi_sync_$replica' cannot be uninstalled now");
--error ER_PLUGIN_CANNOT_BE_UNINSTALLED
eval UNINSTALL PLUGIN rpl_semi_sync_$replica;

# Step 2.3: Check that rpl_semi_sync_source uninstallation on Source is not
#  possible at this state
--source include/rpl/connection_source.inc
eval call mtr.add_suppression("Plugin 'rpl_semi_sync_$source' cannot be uninstalled now");
--error ER_PLUGIN_CANNOT_BE_UNINSTALLED
eval UNINSTALL PLUGIN rpl_semi_sync_$source;

# Step 2.4: Check that replication is working fine at the end of the test case.
CREATE TABLE t1(i int);
INSERT INTO t1 values (2);
DROP TABLE t1;
--sync_slave_with_master

# Step 2.5: Make sure rpl_semi_sync_source_status on Source and
# rpl_semi_sync_replica_staus on Replica are ON
--let $replica_status=[show status like "Rpl_semi_sync_$replica$status", Value, 1]
--let assert_cond= "$replica_status" = "ON"
--let assert_text= semi sync replica status should be ON.
--source include/assert.inc

--source include/rpl/connection_source.inc
--let $source_status=[show status like "Rpl_semi_sync_$source$status", Value, 1]
--let assert_cond= "$source_status" = "ON"
--let assert_text= semi sync source status should be ON.
--source include/assert.inc

--let $source_clients=[show status like "Rpl_semi_sync_$source$clients", Value, 1]
--let assert_cond= $source_clients = 1
--let assert_text= semi sync source clients should be 1.
--source include/assert.inc

#############################################################################
--echo # Case 3: Uninstallation of semi-sync plugin should be disallowed when there
--echo # are semi-sync replicas even though rpl_semi_sync_source_enabled= OFF;.

# Step 3.1: Disable semi-sync on source
--source include/rpl/connection_source.inc
eval SET GLOBAL rpl_semi_sync_$source$enabled = OFF;

# Step 3.2: Check that still Rpl_semi_sync_source_clients is 1
--let $source_clients=[show status like "Rpl_semi_sync_$source$clients", Value, 1]
--let assert_cond= $source_clients = 1
--let assert_text= semi sync source clients should be 1.
--source include/assert.inc

# Step 3.3: Since Rpl_semi_sync_source_clients is 1, uninstallation of
#  rpl_semi_sync_source should be disallowed.
--error ER_PLUGIN_CANNOT_BE_UNINSTALLED
eval UNINSTALL PLUGIN rpl_semi_sync_$source;

#############################################################################
--echo # Case 4: Uninstallation of semi-sync plugin should be allowed when it is not
--echo # in use. Same as Case 1 but this case is to check the case after enabling and
--echo # disabling semi-sync replication.

# Step 4.1: Stop IO thread on replica.
--source include/rpl/connection_replica.inc
--source include/rpl/stop_replica.inc

# Step 4.2: Disable semi-sync on replica.
eval SET GLOBAL rpl_semi_sync_$replica$enabled = OFF;

# Step 4.3: Start IO thread on replica.
--source include/rpl/start_replica.inc

# Step 4.4: Uninstall semi-sync plugin, it should be successful now.
eval UNINSTALL PLUGIN rpl_semi_sync_$replica;

# Step 4.5: On Source, wait until semi-sync replica is '0'.
--source include/rpl/connection_source.inc
--let $status_var= Rpl_semi_sync_$source$clients
--let $status_var_value= 0
--source include/wait_for_status_var.inc

# Step 4.6: So uninstalling semi-sync plugin should be allowed
eval UNINSTALL PLUGIN rpl_semi_sync_$source;

# Step 4.7: Check that replication is working fine at the end of the test case
CREATE TABLE t1(i int);
INSERT INTO t1 values (3);
DROP TABLE t1;
--sync_slave_with_master

# Cleanup
source include/rpl/deinit.inc;
