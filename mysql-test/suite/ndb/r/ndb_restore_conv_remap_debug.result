Check behaviour when restoring with remap
and log content.
Backup type 2
create table t1 (a int auto_increment primary key, b int, c text) engine=ndb;
insert into t1 (b,c) values 
(1, repeat('B', 2000)),
(2, repeat('J', 3000)),
(3, repeat('C', 3500)),
(4, repeat('T', 3300)),
(5, repeat('S', 1234)),
(6, repeat('G', 3333));
select a, b, length(c), sha2(c,256) from t1 order by a;
a	b	length(c)	sha2(c,256)
1	1	2000	e102cc048a84ab60402d04294d30bfd8a7d02fbec6dee1288d7025751975286b
2	2	3000	e40935d88da70e3f2c0ed66f0060a0ea1d94f458530571dd587aebefe70319ee
3	3	3500	1c9926d61f71395c67cb0ac3abd70118c82b68ae896f0ff6ccdde2bcf1d57bb3
4	4	3300	47656d389450494876f0615aae384db2565cebd3407a9e66e5f2c4eb31ff2d7a
5	5	1234	3ba669efdf72f0d314a5db56ff24b3df12b4a206e41f00016fd4e327039e588c
6	6	3333	02eb449600ece673250f46e726318752960d830a16943d02742f4a6059cd7896
Cause backup stall
Starting backup
Backup started
insert into t1 (b,c) values
(7, repeat('D', 999));
insert into t1 (a,b,c) values (1000, 1000, repeat('MU', 444));
delete from t1 where b=4;
update t1 set a=1010 where a=2;
begin;
insert into t1 (a,b,c) values (500, 500, repeat('AR', 1000));
update t1 set c=repeat('AG', 3000) where a=500;
insert into t1 (a,b,c) values (501, 501, repeat('AR', 1000));
update t1 set b=5010 where a=501;
commit;
begin;
insert into t1 (a,b,c) values (502, 502, repeat('AR', 1500));
update t1 set c=repeat('AG', 2000) where a=502;
delete from t1 where a=502;
insert into t1 (a,b,c) values (503, 503, repeat('AR', 1500));
update t1 set b=5030 where a=503;
delete from t1 where a=503;
commit;
begin;
insert into t1 (a,b,c) values (504, 504, repeat('AR', 2000));
update t1 set c=repeat('AG', 2500) where a=504;
delete from t1 where a=504;
insert into t1 (a,b,c) values (504, 5040, repeat('ON', 2500));
insert into t1 (a,b,c) values (505, 505, repeat('AR', 2000));
update t1 set b=5050 where a=505;
delete from t1 where a=505;
insert into t1 (a,b,c) values (505, 50500, repeat('ON', 2000));
commit;
insert into t1 (a,b,c) values (510, 510, repeat('ON', 1500));
insert into t1 (a,b,c) values (511, 511, repeat('AG', 2000));
insert into t1 (a,b,c) values (512, 512, repeat('AR', 2500));
insert into t1 (a,b,c) values (513, 513, repeat('TR', 2500));
insert into t1 (a,b,c) values (514, 514, repeat('IZ', 2500));
insert into t1 (a,b,c) values (515, 515, repeat('EA', 2500));
begin;
update t1 set c=repeat('AG', 2700) where a=510;
delete from t1 where a=510;
update t1 set b=5110 where a=511;
delete from t1 where a=511;
commit;
begin;
update t1 set c=repeat('TR', 1300) where a=512;
delete from t1 where a=512;
insert into t1 (a,b,c) values (512, 5120, repeat('IZ', 2499));
update t1 set b=5130 where a=513;
delete from t1 where a=513;
insert into t1 (a,b,c) values (513, 51300, repeat('ON', 1788));
commit;
begin;
update t1 set c=repeat('ON', 1234) where a=514;
delete from t1 where a=514;
insert into t1 (a,b,c) values (514, 5140, repeat('EA', 1111));
update t1 set c=repeat('AG', 3000) where a=514;
update t1 set b=5150 where a=515;
delete from t1 where a=515;
insert into t1 (a,b,c) values (515, 51500, repeat('TR', 2222));
update t1 set b=515000 where a=515;
commit;
select a, b, length(c), sha2(c,256) from t1 order by a;
a	b	length(c)	sha2(c,256)
1	1	2000	e102cc048a84ab60402d04294d30bfd8a7d02fbec6dee1288d7025751975286b
3	3	3500	1c9926d61f71395c67cb0ac3abd70118c82b68ae896f0ff6ccdde2bcf1d57bb3
5	5	1234	3ba669efdf72f0d314a5db56ff24b3df12b4a206e41f00016fd4e327039e588c
6	6	3333	02eb449600ece673250f46e726318752960d830a16943d02742f4a6059cd7896
7	7	999	e0376347dc7d64569b6949d4f512957067bf5f36393c7e9cd2574d0ea99bcb8d
500	500	6000	b2db7c056d7e1ec85847338a08cdbacdb36f2786a9719f37880c868d67668e0b
501	5010	2000	5c59250ccb306efe208c87577550327520e922db7036fc21657d78dab0c707b7
504	5040	5000	4dd66918fcdaa2d10fc56c88480b7701e58e94e2639437160681db96900839a4
505	50500	4000	a41732865525467cd03e8bdfdb94f50320784f268296cac384610cc0dc2c2e0e
512	5120	4998	373d2298a0ec02505ec8539f0c0a9218c9e6c371fc4e916d8c2bd09f27f3e3e7
513	51300	3576	a6ccfe11313329742aae900dc4ee7a510cd96a21840dec2aeb35dd4678c8a148
514	5140	6000	b2db7c056d7e1ec85847338a08cdbacdb36f2786a9719f37880c868d67668e0b
515	515000	4444	effc1f83bffaccf58d389ba3a8855647b4a7d0d68173368ddbe671451e5174bd
1000	1000	888	a9f1959fbf8632146a41d663250ff6ffb6ca19b903c88ec5e45ea430a50fd161
1010	2	3000	e40935d88da70e3f2c0ed66f0060a0ea1d94f458530571dd587aebefe70319ee
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL AUTO_INCREMENT,
  `b` int DEFAULT NULL,
  `c` text,
  PRIMARY KEY (`a`)
) ENGINE=ndbcluster AUTO_INCREMENT=1011 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
Waiting for backup to complete
Backup completed
drop table test.t1;
Restore data
create table t1 (a int auto_increment primary key, b int, c text) engine=ndb;
Node 1
Node 2
select a, b, length(c), sha2(c,256) from t1 order by a;
a	b	length(c)	sha2(c,256)
4001	1	2000	e102cc048a84ab60402d04294d30bfd8a7d02fbec6dee1288d7025751975286b
4003	3	3500	1c9926d61f71395c67cb0ac3abd70118c82b68ae896f0ff6ccdde2bcf1d57bb3
4005	5	1234	3ba669efdf72f0d314a5db56ff24b3df12b4a206e41f00016fd4e327039e588c
4006	6	3333	02eb449600ece673250f46e726318752960d830a16943d02742f4a6059cd7896
4007	7	999	e0376347dc7d64569b6949d4f512957067bf5f36393c7e9cd2574d0ea99bcb8d
4500	500	6000	b2db7c056d7e1ec85847338a08cdbacdb36f2786a9719f37880c868d67668e0b
4501	5010	2000	5c59250ccb306efe208c87577550327520e922db7036fc21657d78dab0c707b7
4504	5040	5000	4dd66918fcdaa2d10fc56c88480b7701e58e94e2639437160681db96900839a4
4505	50500	4000	a41732865525467cd03e8bdfdb94f50320784f268296cac384610cc0dc2c2e0e
4512	5120	4998	373d2298a0ec02505ec8539f0c0a9218c9e6c371fc4e916d8c2bd09f27f3e3e7
4513	51300	3576	a6ccfe11313329742aae900dc4ee7a510cd96a21840dec2aeb35dd4678c8a148
4514	5140	6000	b2db7c056d7e1ec85847338a08cdbacdb36f2786a9719f37880c868d67668e0b
4515	515000	4444	effc1f83bffaccf58d389ba3a8855647b4a7d0d68173368ddbe671451e5174bd
5000	1000	888	a9f1959fbf8632146a41d663250ff6ffb6ca19b903c88ec5e45ea430a50fd161
5010	2	3000	e40935d88da70e3f2c0ed66f0060a0ea1d94f458530571dd587aebefe70319ee
Check restored auto-inc metadata :
Expect that auto-increment next is 5011, e.g. > highest remapped row that
existed at end of backup time
(note that SNAPSHOTSTART does not snapshot autoinc metadata)

show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL AUTO_INCREMENT,
  `b` int DEFAULT NULL,
  `c` text,
  PRIMARY KEY (`a`)
) ENGINE=ndbcluster AUTO_INCREMENT=5011 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table test.t1;
Backup type 1
create table t1 (a int auto_increment primary key, b int, c text) engine=ndb;
insert into t1 (b,c) values 
(1, repeat('B', 2000)),
(2, repeat('J', 3000)),
(3, repeat('C', 3500)),
(4, repeat('T', 3300)),
(5, repeat('S', 1234)),
(6, repeat('G', 3333));
select a, b, length(c), sha2(c,256) from t1 order by a;
a	b	length(c)	sha2(c,256)
1	1	2000	e102cc048a84ab60402d04294d30bfd8a7d02fbec6dee1288d7025751975286b
2	2	3000	e40935d88da70e3f2c0ed66f0060a0ea1d94f458530571dd587aebefe70319ee
3	3	3500	1c9926d61f71395c67cb0ac3abd70118c82b68ae896f0ff6ccdde2bcf1d57bb3
4	4	3300	47656d389450494876f0615aae384db2565cebd3407a9e66e5f2c4eb31ff2d7a
5	5	1234	3ba669efdf72f0d314a5db56ff24b3df12b4a206e41f00016fd4e327039e588c
6	6	3333	02eb449600ece673250f46e726318752960d830a16943d02742f4a6059cd7896
Cause backup stall
Starting SNAPSHOTSTART backup
Backup started
insert into t1 (b,c) values
(7, repeat('D', 999));
insert into t1 (a,b,c) values (1000, 1000, repeat('MU', 444));
delete from t1 where b=4;
update t1 set a=1010 where a=2;
begin;
insert into t1 (a,b,c) values (500, 500, repeat('AR', 1000));
update t1 set c=repeat('AG', 3000) where a=500;
insert into t1 (a,b,c) values (501, 501, repeat('AR', 1000));
update t1 set b=5010 where a=501;
commit;
begin;
insert into t1 (a,b,c) values (502, 502, repeat('AR', 1500));
update t1 set c=repeat('AG', 2000) where a=502;
delete from t1 where a=502;
insert into t1 (a,b,c) values (503, 503, repeat('AR', 1500));
update t1 set b=5030 where a=503;
delete from t1 where a=503;
commit;
begin;
insert into t1 (a,b,c) values (504, 504, repeat('AR', 2000));
update t1 set c=repeat('AG', 2500) where a=504;
delete from t1 where a=504;
insert into t1 (a,b,c) values (504, 5040, repeat('ON', 2500));
insert into t1 (a,b,c) values (505, 505, repeat('AR', 2000));
update t1 set b=5050 where a=505;
delete from t1 where a=505;
insert into t1 (a,b,c) values (505, 50500, repeat('ON', 2000));
commit;
insert into t1 (a,b,c) values (510, 510, repeat('ON', 1500));
insert into t1 (a,b,c) values (511, 511, repeat('AG', 2000));
insert into t1 (a,b,c) values (512, 512, repeat('AR', 2500));
insert into t1 (a,b,c) values (513, 513, repeat('TR', 2500));
insert into t1 (a,b,c) values (514, 514, repeat('IZ', 2500));
insert into t1 (a,b,c) values (515, 515, repeat('EA', 2500));
begin;
update t1 set c=repeat('AG', 2700) where a=510;
delete from t1 where a=510;
update t1 set b=5110 where a=511;
delete from t1 where a=511;
commit;
begin;
update t1 set c=repeat('TR', 1300) where a=512;
delete from t1 where a=512;
insert into t1 (a,b,c) values (512, 5120, repeat('IZ', 2499));
update t1 set b=5130 where a=513;
delete from t1 where a=513;
insert into t1 (a,b,c) values (513, 51300, repeat('ON', 1788));
commit;
begin;
update t1 set c=repeat('ON', 1234) where a=514;
delete from t1 where a=514;
insert into t1 (a,b,c) values (514, 5140, repeat('EA', 1111));
update t1 set c=repeat('AG', 3000) where a=514;
update t1 set b=5150 where a=515;
delete from t1 where a=515;
insert into t1 (a,b,c) values (515, 51500, repeat('TR', 2222));
update t1 set b=515000 where a=515;
commit;
select a, b, length(c), sha2(c,256) from t1 order by a;
a	b	length(c)	sha2(c,256)
1	1	2000	e102cc048a84ab60402d04294d30bfd8a7d02fbec6dee1288d7025751975286b
3	3	3500	1c9926d61f71395c67cb0ac3abd70118c82b68ae896f0ff6ccdde2bcf1d57bb3
5	5	1234	3ba669efdf72f0d314a5db56ff24b3df12b4a206e41f00016fd4e327039e588c
6	6	3333	02eb449600ece673250f46e726318752960d830a16943d02742f4a6059cd7896
7	7	999	e0376347dc7d64569b6949d4f512957067bf5f36393c7e9cd2574d0ea99bcb8d
500	500	6000	b2db7c056d7e1ec85847338a08cdbacdb36f2786a9719f37880c868d67668e0b
501	5010	2000	5c59250ccb306efe208c87577550327520e922db7036fc21657d78dab0c707b7
504	5040	5000	4dd66918fcdaa2d10fc56c88480b7701e58e94e2639437160681db96900839a4
505	50500	4000	a41732865525467cd03e8bdfdb94f50320784f268296cac384610cc0dc2c2e0e
512	5120	4998	373d2298a0ec02505ec8539f0c0a9218c9e6c371fc4e916d8c2bd09f27f3e3e7
513	51300	3576	a6ccfe11313329742aae900dc4ee7a510cd96a21840dec2aeb35dd4678c8a148
514	5140	6000	b2db7c056d7e1ec85847338a08cdbacdb36f2786a9719f37880c868d67668e0b
515	515000	4444	effc1f83bffaccf58d389ba3a8855647b4a7d0d68173368ddbe671451e5174bd
1000	1000	888	a9f1959fbf8632146a41d663250ff6ffb6ca19b903c88ec5e45ea430a50fd161
1010	2	3000	e40935d88da70e3f2c0ed66f0060a0ea1d94f458530571dd587aebefe70319ee
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL AUTO_INCREMENT,
  `b` int DEFAULT NULL,
  `c` text,
  PRIMARY KEY (`a`)
) ENGINE=ndbcluster AUTO_INCREMENT=1011 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
Waiting for backup to complete
Backup completed
drop table test.t1;
Restore data
create table t1 (a int auto_increment primary key, b int, c text) engine=ndb;
Node 1
Node 2
select a, b, length(c), sha2(c,256) from t1 order by a;
a	b	length(c)	sha2(c,256)
4001	1	2000	e102cc048a84ab60402d04294d30bfd8a7d02fbec6dee1288d7025751975286b
4002	2	3000	e40935d88da70e3f2c0ed66f0060a0ea1d94f458530571dd587aebefe70319ee
4003	3	3500	1c9926d61f71395c67cb0ac3abd70118c82b68ae896f0ff6ccdde2bcf1d57bb3
4004	4	3300	47656d389450494876f0615aae384db2565cebd3407a9e66e5f2c4eb31ff2d7a
4005	5	1234	3ba669efdf72f0d314a5db56ff24b3df12b4a206e41f00016fd4e327039e588c
4006	6	3333	02eb449600ece673250f46e726318752960d830a16943d02742f4a6059cd7896
Check restored auto-inc metadata :
Expect that auto-increment next is 5011, e.g. > highest remapped row that
existed at end of backup time
(note that SNAPSHOTSTART does not snapshot autoinc metadata)

show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL AUTO_INCREMENT,
  `b` int DEFAULT NULL,
  `c` text,
  PRIMARY KEY (`a`)
) ENGINE=ndbcluster AUTO_INCREMENT=5011 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table test.t1;
