include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the connection metadata repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection master]
#
# Initialize
#
[connection slave]
include/suppress_messages.inc
# Connection 2 suppresses message <Replica SQL for channel .*: Worker 1 failed executing transaction.*>.
#
# R1.1. CREATE TABLE fails because table exists on replica
#
[connection slave]
CREATE TABLE t (a INT PRIMARY KEY);
include/save_binlog_position.inc
[connection master]
CREATE TABLE t (a INT PRIMARY KEY);
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP table t;
include/sync_slave_sql_with_master.inc
#
# R1.2. CREATE TABLE ... SELECT fails because table exists on replica
#       with binlog_format=STATEMENT
#
[connection master]
CREATE TABLE t0 (a INT PRIMARY KEY);
INSERT INTO t0 VALUES (1), (2);
include/sync_slave_sql_with_master.inc
CREATE TABLE t (a TEXT);
include/save_binlog_position.inc
[connection master]
SET @@session.binlog_format = STATEMENT;
Warnings:
Warning	1287	'@@binlog_format' is deprecated and will be removed in a future release.
CREATE TABLE t (a INT PRIMARY KEY) SELECT * FROM t0;
SET @@session.binlog_format = ROW;
Warnings:
Warning	1287	'@@binlog_format' is deprecated and will be removed in a future release.
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP TABLE t;
include/sync_slave_sql_with_master.inc
#
# R1.3. CREATE TABLE ... SELECT fails because table exists on replica
#       with binlog_format=ROW
#
[connection slave]
CREATE TABLE t (a TEXT);
include/save_binlog_position.inc
[connection master]
CREATE TABLE t (a INT PRIMARY KEY) SELECT * FROM t0;
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP TABLE t0;
include/sync_slave_sql_with_master.inc
#
# R2. ALTER TABLE fails because table does not exist on replica
#
[connection slave]
DROP TABLE t;
include/save_binlog_position.inc
[connection master]
ALTER TABLE t ADD COLUMN b INT;
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
include/save_binlog_position.inc
#
# R3. OPTIMIZE TABLE fails because table does not exist on replica
#
[connection master]
OPTIMIZE TABLE t;
Table	Op	Msg_type	Msg_text
test.t	optimize	note	Table does not support optimize, doing recreate + analyze instead
test.t	optimize	status	OK
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/.*OPTIMIZE TABLE t]
include/save_binlog_position.inc
#
# R4. CREATE TRIGGER fails because table does not exist on replica
#
[connection master]
CREATE TRIGGER trig BEFORE UPDATE ON t FOR EACH ROW SET @tmp := 1;
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
include/save_binlog_position.inc
#
# R5. DROP TABLE fails because table does not exist on replica
#
[connection master]
DROP TABLE t;
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
#
# R6.1 INSERT fails because row exists: ROW (InnoDB)
#
[connection master]
CREATE TABLE t (a INT PRIMARY KEY) ENGINE = InnoDB;
include/sync_slave_sql_with_master.inc
INSERT INTO t VALUES (1);
include/save_binlog_position.inc
[connection master]
INSERT INTO t VALUES (1);
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
include/save_binlog_position.inc
#
# R7.1 INSERT fails because table does not exist: ROW (InnoDB)
#
[connection slave]
DROP TABLE t;
include/save_binlog_position.inc
[connection master]
INSERT INTO t VALUES (2);
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP TABLE IF EXISTS t;
include/sync_slave_sql_with_master.inc
#
# R6.2 INSERT fails because row exists: STATEMENT (InnoDB)
#
[connection master]
CREATE TABLE t (a INT PRIMARY KEY) ENGINE = InnoDB;
include/sync_slave_sql_with_master.inc
INSERT INTO t VALUES (1);
include/save_binlog_position.inc
[connection master]
INSERT INTO t VALUES (1);
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
include/save_binlog_position.inc
#
# R7.2 INSERT fails because table does not exist: STATEMENT (InnoDB)
#
[connection slave]
DROP TABLE t;
include/save_binlog_position.inc
[connection master]
INSERT INTO t VALUES (2);
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP TABLE IF EXISTS t;
include/sync_slave_sql_with_master.inc
#
# R8. A DDL statement fails with parse error
#
[connection slave]
include/save_binlog_position.inc
[connection master]
# Adding debug point 'binlog_corrupt_query' to @@GLOBAL.debug
CREATE TABLE t (a INT);
# Removing debug point 'binlog_corrupt_query' from @@GLOBAL.debug
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP TABLE IF EXISTS t;
include/sync_slave_sql_with_master.inc
#
# R9. A DML statement fails with parse error
#
[connection master]
CREATE TABLE t (a INT);
include/sync_slave_sql_with_master.inc
include/save_binlog_position.inc
[connection master]
SET @@session.binlog_format = STATEMENT;
Warnings:
Warning	1287	'@@binlog_format' is deprecated and will be removed in a future release.
# Adding debug point 'binlog_corrupt_query' to @@GLOBAL.debug
INSERT INTO t VALUES (1);
# Removing debug point 'binlog_corrupt_query' from @@GLOBAL.debug
SET @@session.binlog_format = ROW;
Warnings:
Warning	1287	'@@binlog_format' is deprecated and will be removed in a future release.
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP TABLE t;
include/sync_slave_sql_with_master.inc
#
# R10. CREATE USER fails because the user exists
#
[connection slave]
CREATE USER user1;
include/save_binlog_position.inc
[connection master]
CREATE USER user1;
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP USER user1;
include/sync_slave_sql_with_master.inc
#
# R11. XA COMMIT fails because the XID does not exist
#
[connection master]
CREATE TABLE t (a INT PRIMARY KEY);
XA START 'a';
INSERT INTO t VALUES (2);
XA END 'a';
XA PREPARE 'a';
include/sync_slave_sql_with_master.inc
[connection slave]
include/wait_for_xa_prepared_count.inc
XA ROLLBACK 'a';
include/save_binlog_position.inc
[connection master]
XA COMMIT 'a';
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
#
# R12. XA ROLLBACK fails because the XID does not exist
#
[connection master]
XA START 'a';
INSERT INTO t VALUES (3);
XA END 'a';
XA PREPARE 'a';
include/sync_slave_sql_with_master.inc
include/wait_for_xa_prepared_count.inc
XA ROLLBACK 'a';
include/save_binlog_position.inc
[connection master]
XA ROLLBACK 'a';
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
#
# R13. INSERT fails within XA START ... XA END ; XA PREPARE
#
[connection slave]
INSERT INTO t VALUES (4);
include/save_binlog_position.inc
[connection master]
XA START 'a';
INSERT INTO t VALUES (4);
XA END 'a';
XA PREPARE 'a';
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
XA ROLLBACK 'a';
DROP TABLE t;
include/sync_slave_sql_with_master.inc
#
# R14. CREATE DATABASE fails because the database exists
#
[connection slave]
CREATE DATABASE db;
include/save_binlog_position.inc
[connection master]
CREATE DATABASE db;
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
#
# R15. DROP DATABASE fails because the database does not exist
#
[connection slave]
DROP DATABASE db;
include/save_binlog_position.inc
[connection master]
DROP DATABASE db;
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
#
# R16. Incident fails
#
[connection slave]
include/save_binlog_position.inc
[connection master]
include/save_binlog_position.inc
include/save_error_log_position.inc
# Adding debug point 'binlog_inject_incident' to @@GLOBAL.debug
CREATE TABLE t (a INT);
# Removing debug point 'binlog_inject_incident' from @@GLOBAL.debug
include/assert_binlog_events.inc [Gtid # Incident]
include/assert_error_log.inc [server: 1, pattern: Non-transactional changes were not written to the binlog. An incident event has been written to the binary log which will stop the replicas.]
include/sync_slave_sql_with_master.inc
include/assert_binlog_events.inc [Gtid # Query/BEGIN # Query/COMMIT]
[connection master]
DROP TABLE IF EXISTS t;
include/sync_slave_sql_with_master.inc
#
# Clean up
#
include/rpl_end.inc
