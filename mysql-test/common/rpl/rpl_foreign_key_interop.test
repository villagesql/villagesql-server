--source include/rpl/init_source_replica.inc

--echo # FR-11) When the source node uses binlog_format='row', the replica must
--echo # perform foreign key cascade actions based on the innodb_native_foreign_keys
--echo # setting on the source node, regardless of the replica's own
--echo # innodb_native_foreign_keys setting

--echo # rows_updated and rows_deleted are not updated in InnoDB FK handling
--echo # but it gets updated with SQL FK handling. This difference is used
--echo # to determine which FK handling is used at the replica node

--echo # Create table and insert data on source
CREATE TABLE parent (id INT PRIMARY KEY) ENGINE=InnoDB;
CREATE TABLE child (id INT, parent_id INT,
FOREIGN KEY (parent_id) REFERENCES parent(id) ON UPDATE CASCADE ON DELETE CASCADE) ENGINE=InnoDB;

--echo # Source Node
INSERT INTO parent VALUES (1), (2), (3);
INSERT INTO child VALUES (1, 1), (2, 2), (3, 3);
SHOW VARIABLES LIKE '%innodb_native_foreign_key%';

--source include/rpl/sync_to_replica.inc
--echo # Replica Node
SELECT * FROM parent;
SELECT * FROM child;
SHOW VARIABLES LIKE '%innodb_native_foreign_key%';

connection master;
--echo # Source Node
SHOW VARIABLES LIKE '%innodb_native_foreign_key%';

UPDATE parent SET id = 100 WHERE id = 1;

DELETE FROM parent where id = 3;

SELECT * FROM parent;
SELECT * FROM child;

SELECT table_name, rows_updated, rows_deleted FROM sys.schema_table_statistics
  WHERE table_schema='test' ORDER BY table_name;

--source include/rpl/sync_to_replica.inc
--echo # Replica Node
SELECT * FROM parent;
SELECT * FROM child;

SELECT table_name, rows_updated, rows_deleted FROM sys.schema_table_statistics
  WHERE table_schema='test' ORDER BY table_name;

connection master;
DROP TABLE parent, child;

--source include/rpl/deinit.inc
