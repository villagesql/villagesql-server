--source include/have_debug.inc

--echo # 1. Test server picks correct initial auth plugin (given in policy)

# Connection will crash the server via debug assert unless
# the 'mysql_native_password' authentication plugin was
# selected as auth plugin for the initial handshake packet
# with server using following settings (via .opt file):
# --authentication_policy="*:mysql_native_password" --mysql-native-password=ON

SET GLOBAL DEBUG="+d,acl_expect_native_initial_auth_plugin";
connect (con1,localhost,root);
SET GLOBAL DEBUG="-d,acl_expect_native_initial_auth_plugin";
connection default;
disconnect con1;

--echo # Restart server with auth policy without two possible initial plugin defaults
--let $restart_parameters=restart:--authentication_policy="*:sha256_password" --mysql-native-password=ON
--source include/restart_mysqld.inc

--echo # 2. Test server picks correct initial auth plugin (not given in policy)

# Connection will crash the server via debug assert unless
# the 'caching_sha2_password' authentication plugin was
# selected as auth plugin for the initial handshake packet
# with server using following settings (both possible defaults not in policy):
# --authentication_policy="*:sha256_password" --mysql-native-password=ON

SET GLOBAL DEBUG="+d,acl_expect_sha2_initial_auth_plugin";
connect (con2,localhost,root);
SET GLOBAL DEBUG="-d,acl_expect_sha2_initial_auth_plugin";
connection default;
disconnect con2;

--echo # 3. Test server refreshes initial auth plugin (policy set at runtime)

SET GLOBAL authentication_policy="*:mysql_native_password";

# Connection will crash the server via debug assert unless
# the 'mysql_native_password' authentication plugin was
# selected as auth plugin for the initial handshake packet
# with server using following settings (set at runtime):
# --authentication_policy="*:mysql_native_password" --mysql-native-password=ON

SET GLOBAL DEBUG="+d,acl_expect_native_initial_auth_plugin";
connect (con3,localhost,root);
SET GLOBAL DEBUG="-d,acl_expect_native_initial_auth_plugin";
connection default;
disconnect con3;

