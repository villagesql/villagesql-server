--source include/have_component_init_then_register.inc

--echo #
--echo # This tests checks dynamic loader rollback
--echo # for case when component's init() fails.
--echo #

--echo
--echo # force the component init() to fail and expect an error
SET GLOBAL DEBUG = '+d,force_component_init_failure';
--error ER_COMPONENTS_LOAD_CANT_INITIALIZE
INSTALL COMPONENT "file://component_test_component_init_then_register";

--echo
--echo # unset debug flag for cleanup
SET GLOBAL DEBUG = '-d,force_component_init_failure';

--echo
--echo # check the component is not installed
SELECT COUNT(component_urn) FROM mysql.component WHERE component_urn='file://component_test_component_init_then_register';

