SET SESSION innodb_lock_wait_timeout = 1;
CREATE TABLE parent(f1 INT PRIMARY KEY, f2 INT);
CREATE TABLE child(f2 INT PRIMARY KEY, f1 INT,
FOREIGN KEY(f1) REFERENCES parent(f1)
ON UPDATE CASCADE ON DELETE CASCADE);
INSERT INTO parent VALUES(10, 10), (20, 20);
INSERT INTO child VALUES(10, 10), (20, 20);
SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
START TRANSACTION;
UPDATE parent SET f1 = 11 WHERE f1 = 10;
START TRANSACTION;
SELECT f1 FROM child WHERE f1 = 10 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
SELECT f1 FROM child WHERE f1 = 11 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
rollback;
SELECT object_schema, object_name, lock_type, lock_duration,
lock_status FROM performance_schema.metadata_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5;
object_schema	object_name	lock_type	lock_duration	lock_status
test	child	SHARED_WRITE	TRANSACTION	GRANTED
test	parent	SHARED_WRITE	TRANSACTION	GRANTED
SELECT object_schema, object_name, index_name, lock_type, lock_mode,
lock_status,
lock_data FROM performance_schema.data_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5, 6, 7;
object_schema	object_name	index_name	lock_type	lock_mode	lock_status	lock_data
test	child	NULL	TABLE	IX	GRANTED	NULL
test	child	f1	RECORD	X,REC_NOT_GAP	GRANTED	10, 10
test	child	f1	RECORD	X,REC_NOT_GAP	GRANTED	11, 10
test	child	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
test	parent	NULL	TABLE	IX	GRANTED	NULL
test	parent	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
COMMIT;
START TRANSACTION;
DELETE FROM parent WHERE f1 = 11;
START TRANSACTION;
SELECT f1 FROM child WHERE f1 = 11 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
rollback;
SELECT object_schema, object_name, lock_type, lock_duration,
lock_status FROM performance_schema.metadata_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5;
object_schema	object_name	lock_type	lock_duration	lock_status
test	child	SHARED_WRITE	TRANSACTION	GRANTED
test	parent	SHARED_WRITE	TRANSACTION	GRANTED
SELECT object_schema, object_name, index_name, lock_type, lock_mode,
lock_status,
lock_data FROM performance_schema.data_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5, 6, 7;
object_schema	object_name	index_name	lock_type	lock_mode	lock_status	lock_data
test	child	NULL	TABLE	IX	GRANTED	NULL
test	child	f1	RECORD	X,REC_NOT_GAP	GRANTED	11, 10
test	child	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
test	parent	NULL	TABLE	IX	GRANTED	NULL
test	parent	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	11
COMMIT;
DROP TABLE child, parent;
CREATE TABLE parent(f1 INT PRIMARY KEY, f2 INT);
CREATE TABLE child(f2 INT PRIMARY KEY, f1 INT,
FOREIGN KEY(f1) REFERENCES parent(f1)
ON UPDATE CASCADE ON DELETE CASCADE);
INSERT INTO parent VALUES(10, 10), (20, 20);
INSERT INTO child VALUES(10, 10), (20, 20);
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
START TRANSACTION;
UPDATE parent SET f1 = 11 WHERE f1 = 10;
START TRANSACTION;
SELECT f1 FROM child WHERE f1 = 10 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
SELECT f1 FROM child WHERE f1 = 11 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
rollback;
SELECT object_schema, object_name, lock_type, lock_duration,
lock_status FROM performance_schema.metadata_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5;
object_schema	object_name	lock_type	lock_duration	lock_status
test	child	SHARED_WRITE	TRANSACTION	GRANTED
test	parent	SHARED_WRITE	TRANSACTION	GRANTED
SELECT object_schema, object_name, index_name, lock_type, lock_mode,
lock_status,
lock_data FROM performance_schema.data_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5, 6, 7;
object_schema	object_name	index_name	lock_type	lock_mode	lock_status	lock_data
test	child	NULL	TABLE	IX	GRANTED	NULL
test	child	f1	RECORD	X,REC_NOT_GAP	GRANTED	10, 10
test	child	f1	RECORD	X,REC_NOT_GAP	GRANTED	11, 10
test	child	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
test	parent	NULL	TABLE	IX	GRANTED	NULL
test	parent	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
COMMIT;
START TRANSACTION;
DELETE FROM parent WHERE f1 = 11;
START TRANSACTION;
SELECT f1 FROM child WHERE f1 = 11 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
rollback;
SELECT object_schema, object_name, lock_type, lock_duration,
lock_status FROM performance_schema.metadata_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5;
object_schema	object_name	lock_type	lock_duration	lock_status
test	child	SHARED_WRITE	TRANSACTION	GRANTED
test	parent	SHARED_WRITE	TRANSACTION	GRANTED
SELECT object_schema, object_name, index_name, lock_type, lock_mode,
lock_status,
lock_data FROM performance_schema.data_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5, 6, 7;
object_schema	object_name	index_name	lock_type	lock_mode	lock_status	lock_data
test	child	NULL	TABLE	IX	GRANTED	NULL
test	child	f1	RECORD	X,REC_NOT_GAP	GRANTED	11, 10
test	child	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
test	parent	NULL	TABLE	IX	GRANTED	NULL
test	parent	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	11
COMMIT;
DROP TABLE child, parent;
CREATE TABLE parent(f1 INT PRIMARY KEY, f2 INT);
CREATE TABLE child(f2 INT PRIMARY KEY, f1 INT,
FOREIGN KEY(f1) REFERENCES parent(f1)
ON UPDATE CASCADE ON DELETE CASCADE);
INSERT INTO parent VALUES(10, 10), (20, 20);
INSERT INTO child VALUES(10, 10), (20, 20);
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION;
UPDATE parent SET f1 = 11 WHERE f1 = 10;
START TRANSACTION;
SELECT f1 FROM child WHERE f1 = 10 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
SELECT f1 FROM child WHERE f1 = 11 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
rollback;
SELECT object_schema, object_name, lock_type, lock_duration,
lock_status FROM performance_schema.metadata_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5;
object_schema	object_name	lock_type	lock_duration	lock_status
test	child	SHARED_WRITE	TRANSACTION	GRANTED
test	parent	SHARED_WRITE	TRANSACTION	GRANTED
SELECT object_schema, object_name, index_name, lock_type, lock_mode,
lock_status,
lock_data FROM performance_schema.data_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5, 6, 7;
object_schema	object_name	index_name	lock_type	lock_mode	lock_status	lock_data
test	child	NULL	TABLE	IX	GRANTED	NULL
test	child	f1	RECORD	X	GRANTED	10, 10
test	child	f1	RECORD	X,GAP	GRANTED	11, 10
test	child	f1	RECORD	X,REC_NOT_GAP	GRANTED	11, 10
test	child	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
test	parent	NULL	TABLE	IX	GRANTED	NULL
test	parent	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
COMMIT;
START TRANSACTION;
DELETE FROM parent WHERE f1 = 11;
START TRANSACTION;
SELECT f1 FROM child WHERE f1 = 11 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
rollback;
SELECT object_schema, object_name, lock_type, lock_duration,
lock_status FROM performance_schema.metadata_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5;
object_schema	object_name	lock_type	lock_duration	lock_status
test	child	SHARED_WRITE	TRANSACTION	GRANTED
test	parent	SHARED_WRITE	TRANSACTION	GRANTED
SELECT object_schema, object_name, index_name, lock_type, lock_mode,
lock_status,
lock_data FROM performance_schema.data_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5, 6, 7;
object_schema	object_name	index_name	lock_type	lock_mode	lock_status	lock_data
test	child	NULL	TABLE	IX	GRANTED	NULL
test	child	f1	RECORD	X	GRANTED	11, 10
test	child	f1	RECORD	X,GAP	GRANTED	20, 20
test	child	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
test	parent	NULL	TABLE	IX	GRANTED	NULL
test	parent	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	11
COMMIT;
DROP TABLE child, parent;
CREATE TABLE parent(f1 INT PRIMARY KEY, f2 INT);
CREATE TABLE child(f2 INT PRIMARY KEY, f1 INT,
FOREIGN KEY(f1) REFERENCES parent(f1)
ON UPDATE CASCADE ON DELETE CASCADE);
INSERT INTO parent VALUES(10, 10), (20, 20);
INSERT INTO child VALUES(10, 10), (20, 20);
SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;
START TRANSACTION;
UPDATE parent SET f1 = 11 WHERE f1 = 10;
START TRANSACTION;
SELECT f1 FROM child WHERE f1 = 10 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
SELECT f1 FROM child WHERE f1 = 11 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
rollback;
SELECT object_schema, object_name, lock_type, lock_duration,
lock_status FROM performance_schema.metadata_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5;
object_schema	object_name	lock_type	lock_duration	lock_status
test	child	SHARED_WRITE	TRANSACTION	GRANTED
test	parent	SHARED_WRITE	TRANSACTION	GRANTED
SELECT object_schema, object_name, index_name, lock_type, lock_mode,
lock_status,
lock_data FROM performance_schema.data_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5, 6, 7;
object_schema	object_name	index_name	lock_type	lock_mode	lock_status	lock_data
test	child	NULL	TABLE	IX	GRANTED	NULL
test	child	f1	RECORD	X	GRANTED	10, 10
test	child	f1	RECORD	X,GAP	GRANTED	11, 10
test	child	f1	RECORD	X,REC_NOT_GAP	GRANTED	11, 10
test	child	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
test	parent	NULL	TABLE	IX	GRANTED	NULL
test	parent	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
COMMIT;
START TRANSACTION;
DELETE FROM parent WHERE f1 = 11;
START TRANSACTION;
SELECT f1 FROM child WHERE f1 = 11 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
rollback;
SELECT object_schema, object_name, lock_type, lock_duration,
lock_status FROM performance_schema.metadata_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5;
object_schema	object_name	lock_type	lock_duration	lock_status
test	child	SHARED_WRITE	TRANSACTION	GRANTED
test	parent	SHARED_WRITE	TRANSACTION	GRANTED
SELECT object_schema, object_name, index_name, lock_type, lock_mode,
lock_status,
lock_data FROM performance_schema.data_locks WHERE object_schema =
'test' order by 1, 2, 3, 4, 5, 6, 7;
object_schema	object_name	index_name	lock_type	lock_mode	lock_status	lock_data
test	child	NULL	TABLE	IX	GRANTED	NULL
test	child	f1	RECORD	X	GRANTED	11, 10
test	child	f1	RECORD	X,GAP	GRANTED	20, 20
test	child	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	10
test	parent	NULL	TABLE	IX	GRANTED	NULL
test	parent	PRIMARY	RECORD	X,REC_NOT_GAP	GRANTED	11
COMMIT;
DROP TABLE child, parent;
